# Enable encryption with TLS

Transport Layer Security (TLS) plays a crucial role in securing database communications.  Just as it protects web traffic, TLS encrypts the data transmitted between database clients and servers, preventing unauthorized access and ensuring confidentiality.

Typically, enabling TLS internally within a highly available database or between a highly available database and client/server applications requires a high level of expertise. This has all been abstracted in Charmed etcd so that configuring TLS requires minimal effort on your end.

etcd provides a secure transport layer for client-server and peer-to-peer communication. The etcd operator charm provides a simple way to enable TLS encryption for both client-to-server and peer-to-peer communication:
- Peer-to-peer (internal to the cluster): All communication between members in the cluster will be encrypted and authenticated using the client certificates. 
- Client-to-server: the etcd client can verify the server identity and provide transport security

etcd also supports mutual TLS authentication, which provides an additional layer of security by requiring clients to present a certificate to the server for authentication. The server then checks whether a trusted CA signed the certificate and decide whether to serve the request.

## Enabling Encryption in Transit
Charmed etcd provides the option of using different CA certificates for client-server and peer-to-peer communication. This allows you to have different levels of trust for the two types of communication. You can also use the same CA certificate for both types of communication.

To enable encryption in transit between etcd members, all you need to do is integrate with a TLS provider such as [Self-Signed Certificates charm](https://charmhub.io/self-signed-certificates) or [Vault](https://charmhub.io/vault) to generate the required certificates and keys.

You can enable peer-to-peer encryption alone, client-to-server encryption alone, or both at the same time.

> **[Self-signed certificates](https://en.wikipedia.org/wiki/Self-signed_certificate) are not recommended for a production environment.**  
Check [this guide](/t/11664) for an overview of the TLS certificates charms available. 

```shell
juju deploy self-signed-certificates --channel edge
```

Wait until `self-signed-certificates` is `active`. Use `juju status --watch 1s` to monitor the progress.

```shell
Model  Controller  Cloud/Region         Version  SLA          Timestamp
test   dev         localhost/localhost  3.6.1    unsupported  07:04:32Z

App                       Version  Status  Scale  Charm                     Channel      Rev  Exposed  Message
charmed-etcd                       active      3  charmed-etcd                             0  no
self-signed-certificates           active      1  self-signed-certificates  latest/edge  238  no

Unit                         Workload  Agent  Machine  Public address  Ports  Message
charmed-etcd/0*              active    idle   1        10.73.32.122
charmed-etcd/1               active    idle   2        10.73.32.131
charmed-etcd/2               active    idle   3        10.73.32.193
self-signed-certificates/0*  active    idle   0        10.73.32.179

Machine  State    Address       Inst id        Base          AZ  Message
0        started  10.73.32.179  juju-5620b5-0  ubuntu@22.04      Running
1        started  10.73.32.122  juju-5620b5-1  ubuntu@24.04      Running
2        started  10.73.32.131  juju-5620b5-2  ubuntu@24.04      Running
3        started  10.73.32.193  juju-5620b5-3  ubuntu@24.04      Running

Integration provider     Requirer                 Interface   Type  Message
charmed-etcd:etcd-peers  charmed-etcd:etcd-peers  etcd_peers  peer
charmed-etcd:restart     charmed-etcd:restart     rolling_op  peer
```

Once the `self-signed-certificates` charm is active, integrate it to the `charmed-etcd` application on the `peer-certificates` endpoint. This will generate the required certificates and keys for peer-to-peer communication.

```shell
juju integrate self-signed-certificates:certificates charmed-etcd:peer-certificates
```

To check that etcd is using the certificates generated by the `self-signed-certificates` charm, run the following command, you can replace the endpoint with the IP address corresponding to the unit you choose to run the command on. 

> The command below uses the `etcdctl` command to list the members of the etcd cluster. If you do not have the `etcdctl` command installed on your local machine, you can install it from the [etcd install page](https://etcd.io/docs/v3.5/install/).

```shell
etcdctl member list --endpoints http://10.73.32.122:2379 -w table
+------------------+---------+---------------+---------------------------+--------------------------+------------+
|        ID        | STATUS  |     NAME      |        PEER ADDRS         |       CLIENT ADDRS       | IS LEARNER |
+------------------+---------+---------------+---------------------------+--------------------------+------------+
| 68327020b9432fc8 | started | charmed-etcd2 | https://10.73.32.193:2380 | http://10.73.32.193:2379 |      false |
| c5aec105e79a433b | started | charmed-etcd1 | https://10.73.32.131:2380 | http://10.73.32.131:2379 |      false |
| c74cb15a5aeade42 | started | charmed-etcd0 | https://10.73.32.122:2380 | http://10.73.32.122:2379 |      false |
+------------------+---------+---------------+---------------------------+--------------------------+------------+
```

You can see that the etcd is running with the peer addresses using `https` and the client addresses using `http`. This indicates that the peer-to-peer communication is encrypted using the certificates generated by the `self-signed-certificates` charm.

## Enabling Client-to-Server Encryption and Authentication

To enable client-to-server encryption and authentication, you need to generate the required certificates and keys for the clients. You can use the same `self-signed-certificates` charm to generate the certificates and keys for the clients.

Just like with peer-to-peer communication, integrate the `self-signed-certificates` charm to the `charmed-etcd` application but this time on the `client-certificates` endpoint. 

> This tutorial is using the same `self-signed-certificates` charm to generate the certificates and keys for the clients. You can also use a different charm to generate the certificates and keys for the clients.


```shell
juju integrate self-signed-certificates:certificates charmed-etcd:client-certificates
```

To check that the etcd server is using the certificates generated by the `self-signed-certificates` charm, run the following command:

```shell
etcdctl member list --endpoints http://10.73.32.122:2379 -w table

{"level":"warn","ts":"2025-02-14T07:14:39.578082Z","logger":"etcd-client","caller":"v3@v3.5.18/retry_interceptor.go:63","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0xc0004a4000/10.73.32.122:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"error reading server preface: EOF\""}
Error: context deadline exceeded
```

You can see that the request failed because `etcdctl` is trying to connect to the server using `http` instead of `https`. This indicates that the client-to-server communication is not encrypted. Let's try to connect using the `https` endpoint.

```shell
etcdctl member list --endpoints https://10.73.32.122:2379 -w table
{"level":"warn","ts":"2025-02-14T07:15:56.051291Z","logger":"etcd-client","caller":"v3@v3.5.18/retry_interceptor.go:63","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0xc000142000/10.73.32.122:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate signed by unknown authority\""}
Error: context deadline exceeded
```

<!-- TODO update getting the CA through etcd charm -->
The request failed because the client is trying to connect to the server using `https` but the server is using a certificate that is not signed by a trusted CA. First, get the certificate authority (CA) certificate from the `self-signed-certificates` charm using the following command:

```shell
juju run self-signed-certificates/0 get-ca-certificate
Running operation 1 with 1 task
  - task 2 on unit-self-signed-certificates-0

Waiting for task 2...
ca-certificate: |-
  -----BEGIN CERTIFICATE-----
  ...
  -----END CERTIFICATE-----
```

Save the CA certificate to a file on your local machine. You can use the following command to save the CA certificate to a file.

```shell
# You need the yq tool to run this command
juju run self-signed-certificates/0 get-ca-certificate --format yaml | yq e '.self-signed-certificates/0.results.ca-certificate' > ca.crt
```

Now that you have the CA certificate, you can use it to verify the server certificate. Use the `etcdctl` command to connect to the server using the `https` endpoint and provide the CA certificate to verify the server certificate through the `--cacert` flag.

```shell
etcdctl member list --endpoints https://10.73.32.122:2379 -w table --cacert ca.crt
{"level":"warn","ts":"2025-02-14T07:36:32.220229Z","caller":"clientv3/retry_interceptor.go:63","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0xc0000361e0/10.73.32.122:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"error reading server preface: remote error: tls: certificate required\""}
Error: context deadline exceeded
```

Remember that the server is configured to also require client authentication. You need to provide the client certificate and key to authenticate the client. You can use the `etcdctl` command to connect to the server using the `https` endpoint and provide the client certificate and key through the `--cert` and `--key` flags.

<!-- TODO change when we are done with mTLS -->
```shell
# Let's grab the client certificate and key from one of the units 
juju ssh charmed-etcd/0 "cat /var/snap/charmed-etcd/common/tls/client.key" > ./client.key
juju ssh charmed-etcd/0 "cat /var/snap/charmed-etcd/common/tls/client.pem" > ./client.pem

etcdctl member list --endpoints https://10.73.32.122:2379 -w table --cacert ca.crt --cert ./client.pem --key ./client.key
+------------------+---------+---------------+---------------------------+---------------------------+------------+
|        ID        | STATUS  |     NAME      |        PEER ADDRS         |       CLIENT ADDRS        | IS LEARNER |
+------------------+---------+---------------+---------------------------+---------------------------+------------+
| 68327020b9432fc8 | started | charmed-etcd2 | https://10.73.32.193:2380 | https://10.73.32.193:2379 |      false |
| c5aec105e79a433b | started | charmed-etcd1 | https://10.73.32.131:2380 | https://10.73.32.131:2379 |      false |
| c74cb15a5aeade42 | started | charmed-etcd0 | https://10.73.32.122:2380 | https://10.73.32.122:2379 |      false |
+------------------+---------+---------------+---------------------------+---------------------------+------------+
```

You can now successfully connect to the server using the `https` endpoint and provide the CA certificate, client certificate, and key to verify the server certificate and authenticate the client. You can also see that `etcd` is running with the client addresses using `https`. This indicates that the client-to-server communication is encrypted.

## Enabling Peer-to-Peer, Client-to-Server, and Mutual TLS Authentication At Once

To enable peer-to-peer, client-to-server, and mutual TLS authentication at once, you can integrate the `charmed-etcd` application with the TLS certificates provider charm on both the `peer-certificates` and `client-certificates` endpoints at the same time.

```shell
juju integrate self-signed-certificates:certificates charmed-etcd:peer-certificates && juju integrate self-signed-certificates:certificates charmed-etcd:client-certificates
```

## Enabling Encryption at Deployment Time

You can also enable encryption at deployment time by integrating the `charmed-etcd` application with the TLS certificates provider charm at deployment charm. The cluster will be deployed with encryption enabled from the start.

```shell
juju deploy self-signed-certificates --channel edge
juju deploy charmed-etcd -n 3 --channel 3.5/edge
juju integrate self-signed-certificates:certificates charmed-etcd:client-certificates && juju integrate self-signed-certificates:certificates charmed-etcd:peer-certificates
```
